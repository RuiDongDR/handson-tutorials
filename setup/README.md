# How to setup tutorial servers on MMCloud

For more detailed explanation of the setup, you can refer [to the documentation here]([https://wanggroup.org/productivity_tips/mmcloud-interactive](https://wanggroup.org/productivity_tips/mmcloud-admin-notes#install-oem-packages)).

### Install software in `oem` mode

Using `--oem-admin` mode (see link above), upon accessing the tmate session, you may now install packages directly into the EFS. Please run the command below to get started on installing the initial packages.

``` bash
curl -fsSL https://raw.githubusercontent.com/StatFunGen/misc/master/bash/pixi/pixi-setup.sh | bash
```

Then, install the course-specific courses with the commands below:
```bash
pixi global install $(curl -fsSL https://raw.githubusercontent.com/cumc/handson-tutorials/main/setup/global_packages.txt | tr '\n' ' ') \
pixi global install --environment r-base $(curl -fsSL https://raw.githubusercontent.com/cumc/handson-tutorials/main/setup/r_packages.txt | grep -v "#" | tr '\n' ' ') \
pixi global install --environment python $(curl -fsSL https://raw.githubusercontent.com/cumc/handson-tutorials/main/setup/python_packages.txt | grep -v "#" | tr '\n' ' ') \
pixi clean cache -y
```

Overall, this should take an hour to install everything. In principle, you would only need to do this once.

The purpose of this job is to setup packages. **Once you are done with the setup, you should quit the `tmate` session and cancel the job to stop the unncessary cost running this setup server.**

## Manage students' computing instances

### Overview

- For a list of student names (in English) we will run a some commands (see below) to generate a file [like this](https://github.com/statgenetics/statgen-courses/blob/master/.github/workflows/rockefeller_2024.csv) and send a PR to that folder. It can be any name but should have `csv` format and extension.
- A couple of minutes after the PR is accepted, test if for a student listed in the CSV file, the corresponding server is avaiable as `https://statgenetics.github.io/statgen-courses/<firstname_lastname>`

### Setting up servers

- To set up servers, you will need to use [this script](https://github.com/cumc/handson-tutorials/blob/main/setup/manage_jobs.py) to submit jobs to cloud at the same time.
- Also, a list of student names will need to be proveide, showing as following:
  ```
  Wang Chao
  Zheng Wei Gang
  ```
  This list only need one column as input. If in the case that you have Chinese vs English names for student, just make sure put the English names as the last column. This script will always load the last column of this list. 

- The script has three sections:
    - `submit`: this is to submit jobs and get job ID generated by `float` command
        - To submit jobs, please include all the information in the following command:
        ```
        python manage_jobs.py submit <input.csv> <output_from_submit.csv> \
        --opcenter <opcenter_ip> \
        --gateway <gateway> \
        --security_group <security_group_id> \
        --efs <efs_mount_point> \
        --bind_script <path_to_bind_mount.sh> \
        --init_script <path_to_host_init.sh> \
        --entrypoint_script_url <url_to_entrypoint.sh>
        ```
        where `bind_script` and `init_script` are available [here](https://github.com/statfungen/mmcloud/tree/main/src). `entrypoint_script` can be found in this folder. As an example:
        ```
        python manage_jobs.py submit students.csv students_submit.csv \
        --opcenter 44.222.241.133 \
        --gateway g-sidlpgb7oi9p48kxycpmn \
        --security_group sg-02867677e76635b25 \
        --efs fs-079aa80256bc0f111.fsx.us-east-1.amazonaws.com@tcp:/is37vb4v \
        --bind_script ~/GIT/github/mmcloud/src/bind_mount.sh \
        --init_script ~/GIT/github/mmcloud/src/host_init.sh \
        --entrypoint_script_url https://raw.githubusercontent.com/cumc/handson-tutorials/refs/heads/main/setup/course_entrypoint.sh \
        --auto_suspension_interval 518400 # 6 days in seconds
        ``` 
        - This step will generate a `csv` file that have two columns, Name and Job ID.
        ```
        Wang Chao,d6fioprtyruft80elx7mn
        Zheng Wei Gang,z0xo3ca8s50j5pnrh2wyi
        ```
       **At this point all jobs are submitted to MMCloud. You need to keep track of these jobs on the OpCenter to make sure they are all "Executing" before moving on to the next step.**
    - `get_url`: this step will collect all the URL generated for each job
        - The output from `submit` will be used to collect URL
        ```
        python manage_jobs.py get_url <output_from_submit.csv> <output_from_geturl.csv>
        ```
        For example,
        ```
        python manage_jobs.py get_url students_submit.csv shenzhen_2025.csv
        ```
        - A list of student names, URL, and job ID will be generated [like this](https://github.com/statgenetics/statgen-courses/blob/master/.github/workflows/shenzhen_2024.csv).
        - After PR the list, the corresponding server is avaiable as `https://statgenetics.github.io/statgen-courses/<firstname_lastname>`
    - `manage`: To suspend, resume, or cancel jobs, `manage` section be can used to do so
        - The output file from `get_url` will be used to manage job status
        ```
        python manage_jobs.py manage <suspend/resume/cancel> <output_from_geturl.csv>
        ```
        For example,
        ```
        python manage_jobs.py manage <suspend/resume/cancel> shenzhen_2025.csv
        ```

### Maintaing the servers

For Maintenance especially when on low budget,
- After everything is setup and tested, we should keep all the instances suspended
- Right before lab session, we resume all instances
- Right after the lab session ends, we suspend again
- If anyone has an issue with their server for whatever reason, we will need to start a new one for him/her (submit job and add a line to the CSV file), and cancel the old one that no longer works.
